# CloudTrailとDynamoDB暗号化の月額コスト試算

## 1. CloudTrailによる監査ログのコスト

### 料金体系（2024年時点）

#### 基本料金
- **管理イベントの最初のコピー**: **無料**（90日間の保持、CloudTrailコンソールで閲覧可能）
- **追加のコピー（S3への配信）**: **$2.00 / 100,000イベント**
- **データイベント**: **$0.10 / 100,000イベント**（DynamoDBデータイベントを記録する場合）

#### S3ストレージ料金
- **標準ストレージ**: **$0.023 / GB / 月**（東京リージョン）
- **リクエスト料金**:
  - PUTリクエスト: $0.005 / 1,000リクエスト
  - GETリクエスト: $0.0004 / 1,000リクエスト

#### CloudTrail Insights（オプション）
- **$0.35 / 100,000イベント**（分析対象イベント）

### コスト試算シナリオ

#### シナリオ1: 最小構成（推奨）

**設定**:
- 管理イベントのみ記録（データイベントは記録しない）
- S3への配信あり（監査ログの長期保存）
- ログ保持期間: 90日

**想定使用量**:
- DynamoDBへのAPI呼び出し: 約100,000回/月
- その他のAWS管理イベント: 約50,000回/月
- **合計**: 約150,000イベント/月

**月額コスト**:
```
管理イベント（S3への配信）:
  150,000イベント × $2.00 / 100,000 = $3.00

S3ストレージ（ログサイズ: 約0.5GB/月、90日保持で約1.5GB）:
  1.5GB × $0.023 = $0.035

S3リクエスト:
  PUT: 約500リクエスト/月 × $0.005 / 1,000 = $0.003
  GET: 約10リクエスト/月 × $0.0004 / 1,000 = $0.000004

合計: 約 $3.04 / 月
```

**📊 月額コスト: 約 $3 / 月**

---

#### シナリオ2: 標準構成（データイベントも記録）

**設定**:
- 管理イベント + DynamoDBデータイベントも記録
- S3への配信あり
- ログ保持期間: 90日

**想定使用量**:
- DynamoDB管理イベント: 約100,000回/月
- DynamoDBデータイベント（GetItem, Query, PutItem等）: 約500,000回/月
- その他のAWS管理イベント: 約50,000回/月
- **合計**: 約650,000イベント/月

**月額コスト**:
```
管理イベント（S3への配信）:
  150,000イベント × $2.00 / 100,000 = $3.00

データイベント:
  500,000イベント × $0.10 / 100,000 = $0.50

S3ストレージ（ログサイズ: 約2GB/月、90日保持で約6GB）:
  6GB × $0.023 = $0.138

S3リクエスト:
  PUT: 約2,000リクエスト/月 × $0.005 / 1,000 = $0.01
  GET: 約20リクエスト/月 × $0.0004 / 1,000 = $0.000008

合計: 約 $3.65 / 月
```

**📊 月額コスト: 約 $3.5-4 / 月**

---

#### シナリオ3: 大規模構成（高トラフィック）

**想定使用量**:
- DynamoDB管理イベント: 約500,000回/月
- DynamoDBデータイベント: 約5,000,000回/月
- その他のAWS管理イベント: 約200,000回/月
- **合計**: 約5,700,000イベント/月

**月額コスト**:
```
管理イベント:
  700,000イベント × $2.00 / 100,000 = $14.00

データイベント:
  5,000,000イベント × $0.10 / 100,000 = $5.00

S3ストレージ（ログサイズ: 約20GB/月、90日保持で約60GB）:
  60GB × $0.023 = $1.38

S3リクエスト:
  PUT: 約10,000リクエスト/月 × $0.005 / 1,000 = $0.05

合計: 約 $20.43 / 月
```

**📊 月額コスト: 約 $20 / 月**

---

### CloudTrail無料枠の活用

**重要**: CloudTrailの管理イベントの最初のコピーは**無料**です。以下の条件で利用できます：
- 直近90日間の管理イベントを無料で記録・検索・ダウンロード可能
- CloudTrailコンソールで直接閲覧可能
- S3への配信が不要であれば、**$0 / 月**で利用可能

**推奨設定**:
- 最小構成では、S3への配信を行わず、CloudTrailコンソールで監視する場合: **$0 / 月**
- 長期保存が必要な場合のみ、S3への配信を有効化: **約 $3 / 月**

---

## 2. DynamoDB暗号化の強化（KMS）のコスト

### 料金体系（2024年時点）

#### AWS管理キー（デフォルト）
- **コスト: $0 / 月**（追加料金なし）
- DynamoDBが自動的に管理
- 暗号化キーの完全な制御は不可

#### カスタマー管理キー（CMK）
- **キー管理**: **$1.00 / 月**（CMKごと）
- **APIリクエスト**: **$0.03 / 10,000リクエスト**
  - 暗号化: データの書き込み時
  - 復号化: データの読み取り時

### コスト試算シナリオ

#### シナリオ1: 小規模（推奨初期構成）

**設定**:
- 1つのDynamoDBテーブルに1つのCMKを使用
- テーブル: 1つ

**想定使用量**:
- DynamoDB読み取りリクエスト: 約100,000回/月（復号化）
- DynamoDB書き込みリクエスト: 約20,000回/月（暗号化）
- **合計**: 約120,000リクエスト/月

**月額コスト**:
```
CMK管理料金:
  1キー × $1.00 = $1.00

APIリクエスト:
  120,000リクエスト × $0.03 / 10,000 = $0.36

合計: 約 $1.36 / 月
```

**📊 月額コスト: 約 $1.5 / 月**

---

#### シナリオ2: 中規模（標準構成）

**想定使用量**:
- DynamoDB読み取りリクエスト: 約500,000回/月
- DynamoDB書き込みリクエスト: 約100,000回/月
- **合計**: 約600,000リクエスト/月

**月額コスト**:
```
CMK管理料金:
  1キー × $1.00 = $1.00

APIリクエスト:
  600,000リクエスト × $0.03 / 10,000 = $1.80

合計: 約 $2.80 / 月
```

**📊 月額コスト: 約 $3 / 月**

---

#### シナリオ3: 大規模（高トラフィック）

**想定使用量**:
- DynamoDB読み取りリクエスト: 約5,000,000回/月
- DynamoDB書き込みリクエスト: 約1,000,000回/月
- **合計**: 約6,000,000リクエスト/月

**月額コスト**:
```
CMK管理料金:
  1キー × $1.00 = $1.00

APIリクエスト:
  6,000,000リクエスト × $0.03 / 10,000 = $18.00

合計: 約 $19.00 / 月
```

**📊 月額コスト: 約 $19 / 月**

---

## 3. 合計コスト試算

### 最小構成（推奨）

| 項目 | 月額コスト |
|------|-----------|
| CloudTrail（管理イベントのみ、S3配信あり） | $3.00 |
| DynamoDB KMS暗号化（小規模） | $1.50 |
| **合計** | **約 $4.50 / 月** |

### 標準構成

| 項目 | 月額コスト |
|------|-----------|
| CloudTrail（管理イベント + データイベント、S3配信あり） | $3.50 |
| DynamoDB KMS暗号化（中規模） | $3.00 |
| **合計** | **約 $6.50 / 月** |

### 大規模構成

| 項目 | 月額コスト |
|------|-----------|
| CloudTrail（管理イベント + データイベント、S3配信あり） | $20.00 |
| DynamoDB KMS暗号化（大規模） | $19.00 |
| **合計** | **約 $39 / 月** |

---

## 4. コスト最適化のポイント

### CloudTrailのコスト削減

1. **無料枠の活用**
   - 最初の90日間の管理イベントは無料
   - S3への配信が不要であれば、CloudTrailコンソールのみで監視: **$0 / 月**

2. **データイベントの選択的記録**
   - すべてのデータイベントを記録するのではなく、重要な操作のみ記録
   - データイベントの記録を無効化することで、大幅なコスト削減が可能

3. **ログ保持期間の最適化**
   - 90日間の保持で十分な場合は、それ以上保持しない
   - S3ライフサイクルポリシーで古いログを自動削除

### DynamoDB KMS暗号化のコスト削減

1. **AWS管理キーの使用**
   - キーの完全な制御が不要な場合は、AWS管理キーを使用: **$0 / 月**
   - CMKが必要な場合のみ、CMKを使用

2. **リクエスト数の削減**
   - キャッシュの活用
   - バッチ処理の使用（BatchGetItem, BatchWriteItem）

3. **キーの共有**
   - 複数のテーブルで同じCMKを使用することで、管理料金を削減

---

## 5. 実際のコスト計算方法

### CloudTrailのコスト計算

```bash
# CloudTrailのイベント数を確認
aws cloudtrail lookup-events --max-results 100

# S3バケットのサイズを確認
aws s3 ls s3://your-cloudtrail-bucket --recursive --summarize
```

### DynamoDB KMSのコスト計算

```bash
# DynamoDBのリクエスト数を確認（CloudWatchメトリクス）
aws cloudwatch get-metric-statistics \
  --namespace AWS/DynamoDB \
  --metric-name ConsumedReadCapacityUnits \
  --dimensions Name=TableName,Value=your-table-name \
  --start-time 2024-01-01T00:00:00Z \
  --end-time 2024-01-31T23:59:59Z \
  --period 86400 \
  --statistics Sum
```

---

## 6. 推奨設定とコスト

### 最小コスト構成（セキュリティを維持）

| 設定 | コスト |
|------|--------|
| CloudTrail（管理イベントのみ、S3配信なし） | $0 / 月 |
| DynamoDB暗号化（AWS管理キー） | $0 / 月 |
| **合計** | **$0 / 月** |

### 推奨構成（バランス型）

| 設定 | コスト |
|------|--------|
| CloudTrail（管理イベント、S3配信あり） | $3 / 月 |
| DynamoDB暗号化（CMK、小規模） | $1.5 / 月 |
| **合計** | **約 $4.5 / 月** |

### 高セキュリティ構成

| 設定 | コスト |
|------|--------|
| CloudTrail（管理イベント + データイベント、S3配信あり） | $3.5 / 月 |
| DynamoDB暗号化（CMK、中規模） | $3 / 月 |
| **合計** | **約 $6.5 / 月** |

---

## 7. まとめ

### 月額コストの目安

| 構成 | CloudTrail | DynamoDB暗号化 | 合計 |
|------|-----------|---------------|------|
| **最小コスト** | $0 | $0 | **$0 / 月** |
| **推奨（小規模）** | $3 | $1.5 | **約 $4.5 / 月** |
| **標準（中規模）** | $3.5 | $3 | **約 $6.5 / 月** |
| **大規模** | $20 | $19 | **約 $39 / 月** |

### 推奨事項

1. **初期段階**: 最小コスト構成から開始（CloudTrail無料枠 + AWS管理キー）
2. **成長段階**: 推奨構成に移行（CloudTrail S3配信 + CMK）
3. **本番環境**: 標準構成を推奨（データイベントも記録）

### 注意事項

- コストは実際の使用量によって変動します
- 定期的にCloudWatchメトリクスで使用量を確認することを推奨します
- コストアラートを設定して、予期しないコスト増加を防止しましょう

---

## 参考リンク

- [AWS CloudTrail 料金](https://aws.amazon.com/jp/cloudtrail/pricing/)
- [AWS KMS 料金](https://aws.amazon.com/jp/kms/pricing/)
- [DynamoDB 料金](https://aws.amazon.com/jp/dynamodb/pricing/)
- [AWS 料金計算ツール](https://calculator.aws/)


