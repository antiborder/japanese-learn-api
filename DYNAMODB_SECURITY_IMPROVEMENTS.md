# DynamoDBセキュリティ強化提案

## 現状のセキュリティ課題

現在のDynamoDBアクセスには以下のセキュリティリスクがあります：

1. **過度に広範なIAM権限**: `DynamoDBCrudPolicy`により、Lambda関数に完全なCRUD権限が付与されている
2. **最小権限の原則に違反**: 各Lambda関数が実際に必要な権限以上の権限を持っている
3. **外部アクセス制限なし**: テーブルレベルでのアクセス制限が設定されていない
4. **監査ログの不備**: すべてのアクセスが記録・監視されていない可能性
5. **暗号化設定の不明確**: データの暗号化設定が明示されていない

## セキュリティ強化方法の一覧表

| # | 方法 | 推奨度 | 難易度 | コスト | 実装優先度 |
|---|------|--------|--------|--------|-----------|
| 1 | IAMポリシーの最小権限化 | ⭐⭐⭐⭐⭐ | 🟢 簡単 | 💰 無料 | **最優先** |
| 2 | DynamoDBリソースベースポリシー | ⭐⭐⭐⭐ | 🟡 中 | 💰 無料 | 高 |
| 3 | VPCエンドポイント経由のアクセス | ⭐⭐⭐ | 🔴 難 | 💰 低 | 低 |
| 4 | CloudTrailによる監査ログ | ⭐⭐⭐⭐⭐ | 🟢 簡単 | 💰 低 | **最優先** |
| 5 | DynamoDB暗号化の強化 | ⭐⭐⭐⭐⭐ | 🟢 簡単 | 💰 低 | **最優先** |
| 6 | IAMポリシー条件の追加 | ⭐⭐⭐⭐ | 🟡 中 | 💰 無料 | 高 |
| 7 | DynamoDB Streams + Lambda監視 | ⭐⭐⭐ | 🟡 中 | 💰 低 | 中 |
| 8 | AWS WAF + API Gateway制限 | ⭐⭐⭐⭐ | 🟡 中 | 💰 低 | 高 |
| 9 | セキュリティグループ/ネットワークACL | ⭐⭐ | 🔴 難 | 💰 中 | 低 |
| 10 | IAMロールの一時的認証情報 | ⭐⭐⭐⭐⭐ | 🟢 簡単 | 💰 無料 | 高 |

**凡例**:
- 推奨度: ⭐⭐⭐⭐⭐ (最高) ～ ⭐ (低)
- 難易度: 🟢 簡単 / 🟡 中 / 🔴 難
- コスト: 💰 無料 / 低 ($1-10/月) / 中 ($10-50/月) / 高 ($50+/月)

## セキュリティ強化方法の詳細提案

### 1. IAMポリシーの最小権限化（推奨）

**概要**: 各Lambda関数に必要な最小限のDynamoDB権限のみを付与する

**推奨度**: ⭐⭐⭐⭐⭐ (最高)
**難易度**: 🟢 簡単
**コスト**: 💰 無料

**実装内容**:
- `DynamoDBCrudPolicy`を削除し、各関数の実際の使用状況に応じたカスタムポリシーを作成
- 読み取り専用関数には`GetItem`、`Query`、`Scan`のみ
- 書き込みが必要な関数には`PutItem`、`UpdateItem`、`DeleteItem`を追加
- インデックスアクセスも明示的に指定

**メリット**:
- セキュリティ侵害時の損害を最小化
- AWS Well-Architected Frameworkのベストプラクティスに準拠
- コストなしで実装可能

**デメリット**:
- 初期設定に時間がかかる
- 新しい操作を追加する際にポリシー更新が必要

---

### 2. DynamoDBリソースベースポリシー（条件付き）

**概要**: DynamoDBテーブルにリソースベースポリシーを設定し、特定の条件でのみアクセスを許可

**推奨度**: ⭐⭐⭐⭐ (高)
**難易度**: 🟡 中
**コスト**: 💰 無料

**実装内容**:
- テーブルにリソースベースポリシーを追加
- 特定のIAMロール/ユーザーのみアクセス許可
- IPアドレス、時間帯、リクエスト元などの条件を追加可能

**メリット**:
- 多層防御の実現
- テーブルレベルでのアクセス制御
- 条件による柔軟なアクセス制御

**デメリット**:
- DynamoDBはリソースベースポリシーを直接サポートしていない（IAMロールで代替）
- 設定が複雑になる可能性

---

### 3. VPCエンドポイント経由のアクセス

**概要**: DynamoDBへのアクセスをVPCエンドポイント経由に限定し、インターネット経由のアクセスをブロック

**推奨度**: ⭐⭐⭐ (中)
**難易度**: 🔴 難
**コスト**: 💰 低（VPCエンドポイント料金: 約$7.20/月 + データ転送料金）

**実装内容**:
- VPCエンドポイント（Gatewayタイプ）を作成
- Lambda関数をVPC内に配置
- セキュリティグループでアクセス制限

**メリット**:
- インターネット経由の不正アクセスを防止
- トラフィックがAWS内部ネットワークに留まる
- データ転送コストの削減（VPC内）

**デメリット**:
- Lambda関数をVPC内に配置するとコールドスタートが増加
- 設定が複雑
- 追加コストが発生
- 現在のLambda関数はVPC外で動作しているため、大きな変更が必要

---

### 4. CloudTrailによる監査ログの有効化

**概要**: すべてのDynamoDB API呼び出しをCloudTrailで記録・監視

**推奨度**: ⭐⭐⭐⭐⭐ (最高)
**難易度**: 🟢 簡単
**コスト**: 💰 低（CloudTrail: 最初の90日間無料、その後$2/100,000イベント）

**実装内容**:
- CloudTrailでDynamoDBイベントを記録
- CloudWatch LogsやS3にログを保存
- 異常なアクセスパターンの検知アラートを設定

**メリット**:
- すべてのアクセスを監査可能
- セキュリティインシデントの早期発見
- コンプライアンス要件の満たし

**デメリット**:
- ログストレージのコストが発生
- ログ分析のための追加ツールが必要な場合がある

---

### 5. DynamoDB暗号化の強化

**概要**: DynamoDBテーブルでAWS KMSによる暗号化を有効化

**推奨度**: ⭐⭐⭐⭐⭐ (最高)
**難易度**: 🟢 簡単
**コスト**: 💰 低（KMS: $1/月 + $0.03/10,000リクエスト）

**実装内容**:
- テーブル作成時にKMSキーを指定
- 既存テーブルの場合は、KMSによる暗号化を有効化（再作成が必要）
- カスタマーマネージドキー（CMK）を使用してより細かい制御

**メリット**:
- 保存データの暗号化
- 暗号化キーの完全な制御
- コンプライアンス要件の満たし

**デメリット**:
- 既存テーブルの場合は再作成が必要（ダウンタイム）
- KMSのコストが発生
- キーローテーションの管理が必要

---

### 6. IAMポリシー条件の追加

**概要**: IAMポリシーに条件（Conditions）を追加してアクセスを制限

**推奨度**: ⭐⭐⭐⭐ (高)
**難易度**: 🟡 中
**コスト**: 💰 無料

**実装内容**:
- IPアドレス制限: `aws:SourceIp`
- リクエスト時間制限: `aws:CurrentTime`
- MFA必須: `aws:MultiFactorAuthPresent`
- リクエスト元の制限: `aws:SourceArn`

**メリット**:
- きめ細かいアクセス制御
- 追加コストなし
- 既存のポリシーに追加するだけで実装可能

**デメリット**:
- 条件の設定が複雑になる可能性
- デバッグが難しくなる場合がある

---

### 7. DynamoDB Streams + Lambdaによる監視

**概要**: DynamoDB Streamsを使用してデータ変更を監視し、異常な操作を検知

**推奨度**: ⭐⭐⭐ (中)
**難易度**: 🟡 中
**コスト**: 💰 低（DynamoDB Streams: 読み込み$0.02/100,000リクエスト、Lambda実行コスト）

**実装内容**:
- DynamoDB Streamsを有効化
- Lambda関数でストリームを処理
- 異常な操作パターン（大量削除、権限のないユーザーからの変更など）を検知
- CloudWatchアラートで通知

**メリット**:
- リアルタイムでの異常検知
- データ変更の完全な監査
- 自動的なセキュリティインシデント対応

**デメリット**:
- 追加のLambda関数が必要
- コストが発生
- 実装と運用の複雑さが増加

---

### 8. AWS WAF + API Gatewayによるアクセス制限

**概要**: API GatewayレベルでWAFを使用して不正なリクエストをブロック

**推奨度**: ⭐⭐⭐⭐ (高)
**難易度**: 🟡 中
**コスト**: 💰 低（WAF: $5/月 + $1/100万リクエスト）

**実装内容**:
- API GatewayにWAFをアタッチ
- IPホワイトリスト/ブラックリストの設定
- レート制限の設定
- 地理的制限の設定

**メリット**:
- アプリケーションレベルでの保護
- DDoS攻撃の緩和
- 詳細なアクセス制御

**デメリット**:
- コストが発生
- 設定が複雑になる可能性
- API Gatewayの前に配置されるため、DynamoDBへの直接アクセスは防げない

---

### 9. セキュリティグループ/ネットワークACL（VPC使用時）

**概要**: Lambda関数をVPC内に配置し、ネットワークレベルでアクセスを制限

**推奨度**: ⭐⭐ (低 - VPC使用時のみ)
**難易度**: 🔴 難
**コスト**: 💰 中（VPC、NAT Gateway、VPCエンドポイントのコスト）

**実装内容**:
- Lambda関数をVPC内に配置
- セキュリティグループでDynamoDBへのアクセスを制限
- ネットワークACLで追加の制限

**メリット**:
- ネットワークレベルでの保護
- 詳細なトラフィック制御

**デメリット**:
- 大幅なアーキテクチャ変更が必要
- コストが高い
- パフォーマンスへの影響（コールドスタート）

---

### 10. IAMロールの一時的認証情報の使用

**概要**: 長期認証情報（Access Key）の使用を禁止し、IAMロールのみを使用

**推奨度**: ⭐⭐⭐⭐⭐ (最高)
**難易度**: 🟢 簡単
**コスト**: 💰 無料

**実装内容**:
- すべてのLambda関数でIAMロールを使用（既に実装済み）
- IAMユーザーのAccess Keyの使用を禁止
- 定期的にAccess Keyを確認し、不要なものを削除
- DBeaverなどの外部ツールではIAMロールの一時認証情報を使用

**メリット**:
- 認証情報の漏洩リスクを低減
- 自動的な認証情報ローテーション
- セキュリティベストプラクティスに準拠

**デメリット**:
- 外部ツールでの使用が複雑になる場合がある
- 一時認証情報の管理が必要

---

## 推奨実装順序

### フェーズ1: 即座に実装すべき項目（優先度: 最高）

1. **IAMポリシーの最小権限化** (#1)
   - セキュリティリスクを最も効果的に削減
   - コストなしで実装可能

2. **CloudTrailによる監査ログの有効化** (#4)
   - すべてのアクセスを記録・監視
   - インシデント対応に必須

3. **DynamoDB暗号化の強化** (#5)
   - データ保護の基本
   - コンプライアンス要件の満たし

### フェーズ2: 中期的に実装すべき項目（優先度: 高）

4. **IAMポリシー条件の追加** (#6)
   - より細かいアクセス制御
   - 追加コストなし

5. **AWS WAF + API Gatewayによるアクセス制限** (#8)
   - アプリケーションレベルでの保護
   - DDoS攻撃の緩和

### フェーズ3: 長期的に検討すべき項目（優先度: 中）

6. **DynamoDB Streams + Lambdaによる監視** (#7)
   - リアルタイム監視
   - 異常検知の自動化

7. **VPCエンドポイント経由のアクセス** (#3)
   - ネットワークレベルの保護
   - アーキテクチャの大幅な変更が必要

---

## 実装チェックリスト

### 即座に実装
- [ ] IAMポリシーの最小権限化
- [ ] CloudTrailの有効化
- [ ] KMSによる暗号化の設定

### 1週間以内
- [ ] IAMポリシー条件の追加
- [ ] 不要なAccess Keyの削除
- [ ] 監査ログの確認方法の確立

### 1ヶ月以内
- [ ] AWS WAFの設定
- [ ] 異常検知アラートの設定
- [ ] セキュリティポリシーの文書化

### 継続的
- [ ] 定期的なアクセスログの確認
- [ ] IAMポリシーの見直し
- [ ] セキュリティ監査の実施

---

## コスト見積もり

### 月額コスト（概算）

| 方法 | 月額コスト |
|------|-----------|
| IAMポリシーの最小権限化 | $0 |
| IAMポリシー条件の追加 | $0 |
| CloudTrail | $2-10（イベント数による） |
| KMS暗号化 | $1-5（リクエスト数による） |
| AWS WAF | $5-15（リクエスト数による） |
| DynamoDB Streams | $2-10（使用量による） |
| VPCエンドポイント | $7.20 + データ転送料金 |

**合計（推奨実装）**: 約$10-30/月

---

## 参考リンク

- [AWS DynamoDB セキュリティベストプラクティス](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/security-best-practices.html)
- [IAMポリシーの最小権限の原則](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)
- [AWS Well-Architected Framework - セキュリティ](https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html)
- [CloudTrailによるDynamoDBイベントの記録](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-user-guide.html)
- [AWS KMSによるDynamoDBの暗号化](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/encryption.how-it-works.html)

